// Jenkinsfile
pipeline {
  agent any

  environment {
    GIT_CREDENTIALS = 'GITLAB_PAT'
    GIT_BRANCH      = 'mirror'
    GIT_URL         = 'https://lab.ssafy.com/s12-final/S12P31D104.git'
  }

  stages {
    stage('Checkout mirror branch') {
      steps {
        echo "ğŸ¯ '${GIT_BRANCH}' ë¸Œëœì¹˜ í´ë¡  ì¤‘..."
        checkout([
          $class: 'GitSCM',
          branches: [[ name: "refs/heads/${GIT_BRANCH}" ]],
          extensions: [
            [ $class: 'GitLFSPull' ],
            [ $class: 'CloneOption', noTags: false, shallow: false, timeout: 20 ]
          ],
          userRemoteConfigs: [[
            url:           "${GIT_URL}",
            credentialsId: "${GIT_CREDENTIALS}"
          ]]
        ])
      }
    }

    stage('Build & Push Images') {
      steps {
        echo 'ğŸ› ï¸  Docker Compose ë¹Œë“œ ì‹œì‘â€¦'
        sh 'docker version'
        sh 'docker compose version'
        sh 'docker compose build --parallel'
        // í•„ìš”í•˜ë‹¤ë©´ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œ
        // sh 'docker compose push'
      }
    }

    stage('Deploy') {
      steps {
        echo 'ğŸš€  Docker Compose ë°°í¬ ì¤‘â€¦'
        sh '''
          docker compose down || true
          docker compose up -d
        '''
      }
    }

    stage('Verify') {
      steps {
        echo 'ğŸ”  í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:'
        sh 'docker ps --format "table {{.Names}}\\t{{.Ports}}"'
      }
    }
  }

post {
        success {
            script {
                def Author_ID = sh(
                    script: "git show -s --pretty=%an",
                    returnStdout: true
                ).trim()
                mattermostSend(
                    color: 'good',
                    message: "Mirror Server ë¹Œë“œ ì„±ê³µ!: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}\n(<${env.BUILD_URL}|Details>)",
                    endpoint: 'https://meeting.ssafy.com/hooks/31rxdtq1tbr49qz1bxmc4quede',
                    channel: 'game_jenkins'
                )
            }
        }
        failure {
            script {
                def Author_ID = sh(
                    script: "git show -s --pretty=%an",
                    returnStdout: true
                ).trim()
                mattermostSend(
                    color: 'danger',
                    message: "Mirror Server ë¹Œë“œ ì‹¤íŒ¨ã… : ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}\n(<${env.BUILD_URL}|Details>)",
                    endpoint: 'https://meeting.ssafy.com/hooks/31rxdtq1tbr49qz1bxmc4quede',
                    channel: 'game_jenkins'
                )
            }
        }
    }

}
